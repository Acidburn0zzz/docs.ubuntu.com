<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>How preseeds work in MAAS &mdash; MAAS dev documentation</title>
    
    <link rel="stylesheet" href="/static/maas-1.9/flasky.css" type="text/css" />
    <link rel="stylesheet" href="/static/maas-1.9/pygments.css" type="text/css" />
    <link rel="stylesheet" href="https://assets.ubuntu.com/sites/guidelines/css/latest/ubuntu-styles.css" type="text/css" />
    <link rel="stylesheet" href="https://assets.ubuntu.com/sites/ubuntu/latest/u/css/global.css" type="text/css" />
    <link rel="stylesheet" href="/static/maas-1.9/css/main.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     'dev',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="/static/maas-1.9/jquery.js"></script>
    <script type="text/javascript" src="/static/maas-1.9/underscore.js"></script>
    <script type="text/javascript" src="/static/maas-1.9/doctools.js"></script>
    <link rel="shortcut icon" href="/static/maas-1.9/maas.ico"/>
    <link rel="author" title="About these documents" href="../about.html" />
    <link rel="top" title="MAAS dev documentation" href="../index.html" />
    <link rel="next" title="The Metadata API" href="metadata.html" />
    <link rel="prev" title="DHCP lease scanning and DNS" href="lease-scanning-and-dns.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="metadata.html" title="The Metadata API"
             accesskey="N">next</a></li>
        <li class="right" >
          <a href="lease-scanning-and-dns.html" title="DHCP lease scanning and DNS"
             accesskey="P">previous</a> |</li>
  <li class="nav-item nav-item-0">
    <a href="http://maas.io/docs/">Latest documentation</a>&nbsp;&nbsp;|&nbsp;&nbsp;
  </li>
  <li class="nav-item nav-item-0">
    <a href="../index.html">MAAS dev documentation</a>
  </li>
 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="how-preseeds-work-in-maas">
<span id="preseeds"></span><h1>How preseeds work in MAAS<a class="headerlink" href="preseeds.html#how-preseeds-work-in-maas" title="Permalink to this headline">¶</a></h1>
<p>A preseed is what MAAS sends to the <code class="docutils literal"><span class="pre">cloud-init</span></code> process that starts up
as part of node enlistment, commissioning and installation.  It is a
specially formatted chunk of text.  MAAS does not care what that formatting
is, it just knows it is text and uses <a class="reference external" href="http://pythonpaste.org/tempita/">Tempita</a> templates to render a final
file based on variables that are required depending on the context.</p>
<div class="section" id="preseed-templates">
<h2>Preseed templates<a class="headerlink" href="preseeds.html#preseed-templates" title="Permalink to this headline">¶</a></h2>
<p>On a live system, the preseed templates live in <code class="docutils literal"><span class="pre">/etc/maas/preseeds/</span></code>.</p>
<p>Each template uses a prefix that corresponds to a particular &#8220;phase&#8221;:</p>
<table border="1" class="docutils">
<colgroup>
<col width="37%" />
<col width="63%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Phase</th>
<th class="head">Prefix used</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Enlistment</td>
<td>enlist</td>
</tr>
<tr class="row-odd"><td>Commissioning</td>
<td>commissioning</td>
</tr>
<tr class="row-even"><td>Installation</td>
<td>preseed_master (<a class="reference external" href="https://www.debian.org/devel/debian-installer/">DI</a>) or
curtin (<a class="reference external" href="https://launchpad.net/curtin">Curtin</a>)</td>
</tr>
</tbody>
</table>
<p>Note that the preseed information is in fact composed of two files: the
preseed file per se which usually contains little more than a URL and the
credentials where to get the &#8220;user data&#8221; which, in turn, contains most of
the logic to be executed.</p>
</div>
<div class="section" id="installation-preseed">
<h2>Installation preseed<a class="headerlink" href="preseeds.html#installation-preseed" title="Permalink to this headline">¶</a></h2>
<p>The installation preseed is broken into the three files because the
requirements are different depending on the installer being used.  The
<a class="reference external" href="https://www.debian.org/devel/debian-installer/">Debian Installer</a> uses <code class="docutils literal"><span class="pre">preseed_master</span></code> and the newer <a class="reference external" href="https://launchpad.net/curtin">Curtin</a> installer
uses <code class="docutils literal"><span class="pre">curtin_userdata</span></code>.</p>
<p>The base of both of these is <code class="docutils literal"><span class="pre">generic</span></code>, which defines some variables
and then selects the right one depending on the installer being used.  Note
that Tempita&#8217;s inheritance mechanism is a little weird; the <code class="docutils literal"><span class="pre">generic</span></code>
template inherits the right file but in effect this is in reverse, the
inherited file becomes the new template and it can then reference the
variables defined in <code class="docutils literal"><span class="pre">generic</span></code>.</p>
</div>
<div class="section" id="user-provided-preseeds">
<h2>User-provided preseeds<a class="headerlink" href="preseeds.html#user-provided-preseeds" title="Permalink to this headline">¶</a></h2>
<p>In addition to the standard preseed files, the base preseeds can be
overridden on a per-OS, architecture, subarchitecture, OS release and
node name basis. The templates are looked up in the following order:</p>
<div class="highlight-python"><div class="highlight"><pre>{prefix}_{osystem}_{node_arch}_{node_subarch}_{release}_{node_name}
{prefix}_{osystem}_{node_arch}_{node_subarch}_{release}
{prefix}_{osystem}_{node_arch}_{node_subarch}
{prefix}_{osystem}_{node_arch}
{prefix}_{osystem}
{prefix}
&#39;generic&#39;

Note: in order to be backward-compatible with earlier versions of MAAS that
only supported the Ubuntu OS, if the node OS is Ubuntu paths without the
{osystem} are also tried:
{prefix}_{osystem}_{node_arch}_{node_subarch}_{release}_{node_name}
{prefix}_{node_arch}_{node_subarch}_{release}_{node_name}
{prefix}_{osystem}_{node_arch}_{node_subarch}_{release}
{prefix}_{node_arch}_{node_subarch}_{release}
{prefix}_{osystem}_{node_arch}_{node_subarch}
{prefix}_{node_arch}_{node_subarch}
{prefix}_{osystem}_{node_arch}
{prefix}_{node_arch}
{prefix}_{osystem}
{prefix}
&#39;generic&#39;
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">prefix</span></code> is either empty (in which case the following underscore is also
ommitted: e.g. {osystem}_{node_arch}_{node_subarch}_{release}) or one of
<code class="docutils literal"><span class="pre">enlist</span></code>, <code class="docutils literal"><span class="pre">enlist_userdata</span></code>, <code class="docutils literal"><span class="pre">commissioning</span></code>, <code class="docutils literal"><span class="pre">curtin</span></code>,
<code class="docutils literal"><span class="pre">curtin_userdata</span></code> or <code class="docutils literal"><span class="pre">preseed_master</span></code>.</p>
<p>As you can see this mechanism is also used to calculate the base preseeds for
all of installation, enlistment and commissioning.  It allows end users to
add, for example, a file named <code class="docutils literal"><span class="pre">curtin_ubuntu_amd64_generic</span></code> that would be
used at installation time.</p>
</div>
<div class="section" id="curtin-configuration">
<h2>Curtin configuration<a class="headerlink" href="preseeds.html#curtin-configuration" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://launchpad.net/curtin">Curtin</a> is the tool responsible for performing the OS installation.  If you
need to customize the installation, you need to change Curtin&#8217;s user data
(by either changing the existing <code class="docutils literal"><span class="pre">curtin_userdata</span></code> file or adding a custom
version as described above).</p>
<p>There isn&#8217;t a complete documentation on how to customize Curtin at the time of
this writing but the following instructions and examples should cover most of
the use cases.</p>
<p>Curtin provides hooks to execute custom code before (<cite>early</cite>) or after (<cite>late</cite>)
the installation takes place.  You can override these hooks to execute code,
either code that will run in the ephemeral environment or in the machine being
installed itself (<cite>in-target</cite>).  Note that you can execute <cite>in-target</cite> code
only in a <cite>late</cite> command.</p>
<div class="section" id="example-early-command">
<h3>Example: early command<a class="headerlink" href="preseeds.html#example-early-command" title="Permalink to this headline">¶</a></h3>
<p>Here is an example of an early command (i.e. one that will run before the
installation takes place) that runs in the ephemeral environment and
pings an external machine to signal that the installation is about to start.</p>
<div class="code yaml highlight-python"><div class="highlight"><pre>early_commands:
  signal: [wget, &#39;--no-proxy&#39;, &#39;http://example.com/&#39;, &#39;--post-data&#39;, &#39;system_id={{node.system_id}}&amp;signal=starting_install&#39;, &#39;-O&#39;, &#39;/dev/null&#39;]
</pre></div>
</div>
</div>
<div class="section" id="example-late-command">
<h3>Example: late command<a class="headerlink" href="preseeds.html#example-late-command" title="Permalink to this headline">¶</a></h3>
<p>Here is an example of two late commands (i.e. commands that will run after the
installation has been performed).  Both run <cite>in-target</cite> (i.e. in the machine
being installed).  The first command adds a PPA to the machine.  The second
command create a file containing the node&#8217;s system_id.  (Note that these are
just examples of the things that can be done.)</p>
<div class="code yaml highlight-python"><div class="highlight"><pre>late_commands:
  add_repo: [&quot;curtin&quot;, &quot;in-target&quot;, &quot;--&quot;, &quot;add-apt-repository&quot;, &quot;-y&quot;, &quot;ppa:my/ppa&quot;]
  custom: curtin in-target -- sh -c &quot;/bin/echo -en &#39;Installed {{node.system_id}}&#39; &gt; /tmp/maas_system_id&quot;
</pre></div>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<a style="border:0" title="MAAS Documentation Homepage" href="../index.html"><img src="/static/maas-1.9/maas-logo-200.png" alt="MAAS logo"/></a>
<h2 style="text-align:center;">MAAS</h2>
<p style="font-style:italic;font-size:0.9em; text-align:center; margin-bottom:1.5em">Metal As A Service.</p>
<span id="version_switcher"></span>
<br/>
<br/>

  <ul>
<li><a class="reference internal" href="preseeds.html#">How preseeds work in MAAS</a><ul>
<li><a class="reference internal" href="preseeds.html#preseed-templates">Preseed templates</a></li>
<li><a class="reference internal" href="preseeds.html#installation-preseed">Installation preseed</a></li>
<li><a class="reference internal" href="preseeds.html#user-provided-preseeds">User-provided preseeds</a></li>
<li><a class="reference internal" href="preseeds.html#curtin-configuration">Curtin configuration</a><ul>
<li><a class="reference internal" href="preseeds.html#example-early-command">Example: early command</a></li>
<li><a class="reference internal" href="preseeds.html#example-late-command">Example: late command</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<script type="text/javascript">
$(document).ready(function () {
  if (true) {
    $.ajaxSetup({cache: true});
    $.getScript('/static/maas-1.9/versions.js', function() {
      console.log( "Versions script loaded." );
      set_up_version_switcher('#version_switcher', 'docs');
    });
}
});
</script>

<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
      <li>Previous: <a href="lease-scanning-and-dns.html" title="previous chapter">DHCP lease scanning and DNS</a></li>
      <li>Next: <a href="metadata.html" title="next chapter">The Metadata API</a></li>
  </ul></li>
</ul>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="/static/maas-1.9/development/preseeds.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="metadata.html" title="The Metadata API"
             >next</a></li>
        <li class="right" >
          <a href="lease-scanning-and-dns.html" title="DHCP lease scanning and DNS"
             >previous</a> |</li>
  <li class="nav-item nav-item-0">
    <a href="http://maas.io/docs/">Latest documentation</a>&nbsp;&nbsp;|&nbsp;&nbsp;
  </li>
  <li class="nav-item nav-item-0">
    <a href="../index.html">MAAS dev documentation</a>
  </li>
 
      </ul>
    </div>
<footer class="global clearfix">
  <div class="legal clearfix">
    <p>&copy; Copyright 2012-2015, MAAS Developers. Ubuntu and Canonical are registered trademarks of
      <a href="http://canonical.com">Canonical Ltd</a>.
    </p>
    <p>
      Revision 4595
 (2016-08-24 14:59:26 +0000).
      Documentation generation date: 2016-08-24 16:22:23 +0100.
    </p>
  </div>
</footer>
  </body>
</html>